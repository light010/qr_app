<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Verification</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            background: #f0f0f0;
        }
        #video {
            width: 100%;
            max-width: 500px;
            border: 3px solid #007AFF;
            border-radius: 12px;
            background: #000;
            display: block;
            margin: 20px auto;
        }
        #canvas {
            width: 100%;
            max-width: 500px;
            border: 3px solid #30D158;
            border-radius: 12px;
            display: none;
            margin: 20px auto;
        }
        .info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0051D5;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>Camera Stream Verification</h1>
    
    <div class="info">
        <strong>Camera Status:</strong> <span id="status">Initializing...</span>
    </div>
    
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>
    
    <div style="text-align: center;">
        <button onclick="startCamera()">Start Camera</button>
        <button onclick="takeSnapshot()">Take Snapshot</button>
        <button onclick="checkStream()">Check Stream Info</button>
    </div>
    
    <div id="stream-info" class="info" style="display: none;">
        <h3>Stream Information:</h3>
        <pre id="stream-details"></pre>
    </div>
    
    <div id="snapshot-info" class="info" style="display: none;">
        <h3>Snapshot Analysis:</h3>
        <p id="snapshot-details"></p>
    </div>
    
    <div class="info warning">
        <strong>Troubleshooting:</strong>
        <ol>
            <li><strong>Black Screen?</strong> Check if camera lens is covered</li>
            <li><strong>Windows Settings:</strong> Go to Settings → Privacy → Camera → Allow apps to access camera</li>
            <li><strong>Browser Permissions:</strong> Click the camera icon in address bar</li>
            <li><strong>Try Different Browser:</strong> Chrome, Firefox, or Edge</li>
        </ol>
    </div>

    <script>
        let stream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        async function startCamera() {
            const statusEl = document.getElementById('status');
            
            try {
                statusEl.textContent = 'Requesting camera access...';
                
                // Stop any existing stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Request camera with specific constraints
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 },
                        facingMode: 'user' // Use front camera on laptop
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                
                // Wait for video to load
                video.onloadedmetadata = () => {
                    statusEl.textContent = `✅ Camera active: ${video.videoWidth}x${video.videoHeight}`;
                    statusEl.className = 'success';
                    
                    // Set canvas size to match video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };
                
            } catch (error) {
                statusEl.textContent = `❌ Error: ${error.name} - ${error.message}`;
                statusEl.className = 'error';
                console.error('Camera error:', error);
            }
        }
        
        function takeSnapshot() {
            if (!stream || video.readyState !== 4) {
                alert('Camera not ready. Please start camera first.');
                return;
            }
            
            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0);
            canvas.style.display = 'block';
            
            // Analyze the image
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let totalBrightness = 0;
            let blackPixels = 0;
            const threshold = 10; // Pixels darker than this are considered "black"
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = (r + g + b) / 3;
                
                totalBrightness += brightness;
                
                if (brightness < threshold) {
                    blackPixels++;
                }
            }
            
            const totalPixels = data.length / 4;
            const avgBrightness = totalBrightness / totalPixels;
            const blackPercentage = (blackPixels / totalPixels) * 100;
            
            const details = document.getElementById('snapshot-details');
            details.innerHTML = `
                Average Brightness: ${avgBrightness.toFixed(1)}/255<br>
                Black Pixels: ${blackPercentage.toFixed(1)}%<br>
                ${blackPercentage > 90 ? 
                    '<strong style="color: red;">⚠️ Camera appears to be covered or showing black!</strong>' : 
                    '<strong style="color: green;">✅ Camera is showing an image!</strong>'}
            `;
            
            document.getElementById('snapshot-info').style.display = 'block';
        }
        
        function checkStream() {
            if (!stream) {
                alert('No camera stream. Please start camera first.');
                return;
            }
            
            const track = stream.getVideoTracks()[0];
            const settings = track.getSettings();
            const capabilities = track.getCapabilities();
            
            const info = {
                'Track Label': track.label,
                'Track State': track.readyState,
                'Track Enabled': track.enabled,
                'Settings': settings,
                'Capabilities': capabilities
            };
            
            document.getElementById('stream-details').textContent = JSON.stringify(info, null, 2);
            document.getElementById('stream-info').style.display = 'block';
        }
        
        // Auto-start camera on load
        window.addEventListener('load', () => {
            setTimeout(startCamera, 500);
        });
    </script>
</body>
</html>