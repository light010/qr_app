<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Access Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .test-item {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            background: #007AFF;
            color: white;
            cursor: pointer;
        }
        #video {
            width: 100%;
            max-width: 400px;
            border: 2px solid #007AFF;
            border-radius: 8px;
            display: none;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Camera Access Diagnostic</h1>
    
    <div id="protocol-check" class="test-item">
        <strong>Protocol Check:</strong> <span id="protocol-status">Checking...</span>
    </div>
    
    <div id="secure-context" class="test-item">
        <strong>Secure Context:</strong> <span id="secure-status">Checking...</span>
    </div>
    
    <div id="media-devices" class="test-item">
        <strong>MediaDevices API:</strong> <span id="media-status">Checking...</span>
    </div>
    
    <div id="camera-test" class="test-item">
        <strong>Camera Test:</strong>
        <button onclick="testCamera()">Test Camera Access</button>
        <div id="camera-result" style="margin-top: 10px;"></div>
    </div>
    
    <video id="video" playsinline muted autoplay></video>
    
    <div id="device-info" class="test-item info">
        <strong>Device Information:</strong>
        <pre id="device-details"></pre>
    </div>
    
    <div id="instructions" class="test-item info">
        <strong>Common Solutions:</strong>
        <ol>
            <li><strong>HTTP Protocol:</strong> Camera requires HTTPS or localhost. If you see "http://" in your URL (not localhost), camera won't work.</li>
            <li><strong>Permission Denied:</strong> Check browser settings ‚Üí Site Settings ‚Üí Camera ‚Üí Allow</li>
            <li><strong>iOS Safari:</strong> Settings ‚Üí Safari ‚Üí Camera ‚Üí Ask/Allow</li>
            <li><strong>Use localhost:</strong> Access via http://localhost:8000 instead of IP address</li>
            <li><strong>Use HTTPS:</strong> Deploy to GitHub Pages or use ngrok for HTTPS tunnel</li>
        </ol>
    </div>

    <script>
        // Check protocol
        const protocol = window.location.protocol;
        const protocolEl = document.getElementById('protocol-status');
        const protocolDiv = document.getElementById('protocol-check');
        
        if (protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            protocolEl.textContent = `‚úì ${protocol} (${window.location.hostname})`;
            protocolDiv.classList.add('pass');
        } else {
            protocolEl.textContent = `‚úó ${protocol} - Camera requires HTTPS or localhost!`;
            protocolDiv.classList.add('fail');
        }
        
        // Check secure context
        const secureEl = document.getElementById('secure-status');
        const secureDiv = document.getElementById('secure-context');
        
        if (window.isSecureContext) {
            secureEl.textContent = '‚úì Secure context detected';
            secureDiv.classList.add('pass');
        } else {
            secureEl.textContent = '‚úó Not a secure context - Camera will not work!';
            secureDiv.classList.add('fail');
        }
        
        // Check MediaDevices API
        const mediaEl = document.getElementById('media-status');
        const mediaDiv = document.getElementById('media-devices');
        
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            mediaEl.textContent = '‚úì MediaDevices API available';
            mediaDiv.classList.add('pass');
        } else {
            mediaEl.textContent = '‚úó MediaDevices API not available';
            mediaDiv.classList.add('fail');
        }
        
        // Device info
        const deviceInfo = {
            'User Agent': navigator.userAgent,
            'Platform': navigator.platform,
            'Protocol': window.location.protocol,
            'Hostname': window.location.hostname,
            'Port': window.location.port || '(default)',
            'Secure Context': window.isSecureContext,
            'MediaDevices': !!navigator.mediaDevices,
            'getUserMedia': !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
        };
        
        document.getElementById('device-details').textContent = JSON.stringify(deviceInfo, null, 2);
        
        // Camera test function
        async function testCamera() {
            const resultDiv = document.getElementById('camera-result');
            const video = document.getElementById('video');
            
            try {
                resultDiv.innerHTML = '<span style="color: blue;">üîÑ Requesting camera access...</span>';
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                
                resultDiv.innerHTML = '<span style="color: green;">‚úÖ Camera access granted! You should see the video feed below.</span>';
                
                // List available devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length > 0) {
                    resultDiv.innerHTML += '<br><br><strong>Available Cameras:</strong><ul>';
                    videoDevices.forEach((device, index) => {
                        resultDiv.innerHTML += `<li>Camera ${index + 1}: ${device.label || 'Unnamed camera'}</li>`;
                    });
                    resultDiv.innerHTML += '</ul>';
                }
                
            } catch (error) {
                video.style.display = 'none';
                
                let errorMessage = `<span style="color: red;">‚ùå Camera Error: ${error.name}</span><br><br>`;
                
                switch(error.name) {
                    case 'NotAllowedError':
                        errorMessage += 'Camera permission was denied. Please allow camera access and reload the page.';
                        break;
                    case 'NotFoundError':
                        errorMessage += 'No camera found on this device.';
                        break;
                    case 'NotReadableError':
                        errorMessage += 'Camera is already in use by another application.';
                        break;
                    case 'OverconstrainedError':
                        errorMessage += 'Camera constraints cannot be satisfied.';
                        break;
                    case 'SecurityError':
                        errorMessage += 'Camera access is not allowed in this context. Use HTTPS or localhost.';
                        break;
                    default:
                        errorMessage += `Details: ${error.message}`;
                }
                
                resultDiv.innerHTML = errorMessage;
                
                // Log full error for debugging
                console.error('Camera error:', error);
            }
        }
    </script>
</body>
</html>